<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (c) 2019 Nineva Studios
-->
<root xmlns:android="http://schemas.android.com/apk/res/android">

  <init>
    <log text="Mqtt Utilities initialization"/>

    <setBoolFromProperty result="UseCustomSecurityConfig" ini="Engine" section="/Script/MqttUtilities.MqttUtilitiesSettings" property="UseCustomSecurityConfig" default="false"/>
    <setStringFromProperty result="CertName" ini="Engine" section="/Script/MqttUtilities.MqttUtilitiesSettings" property="AndroidCertificateName" default="broker_crt"/>
    <setStringReplace result="DefaultCertDir" source="$S(PluginDir)" find="/Source/MqttUtilities" with="/Resources/AndroidCertificates" />
  </init>

  <prebuildCopies>
    <copyDir src="$S(PluginDir)/Private/Java" dst="$S(BuildDir)/src/com/ninevastudios/mqttdemo" />
    <if condition="UseCustomSecurityConfig">
      <true>
        <copyFile src="$S(PluginDir)/network_security_config.xml" dst="$S(BuildDir)/res/xml/network_security_config.xml" />
        <copyFile src="$S(DefaultCertDir)/$S(CertName)" dst="$S(BuildDir)/res/raw/$S(CertName)" />
      </true>
    </if>
  </prebuildCopies>

  <!-- optional additions to proguard -->
  <proguardAdditions>
    <insert>
      -keep public class com.ninevastudios.mqttdemo.** {
      public protected *;
      }
      -keep public class org.eclipse.paho.** {
      public protected *;
      }
    </insert>
  </proguardAdditions>

  <!-- optional updates applied to AndroidManifest.xml -->
  <androidManifestUpdates>
    <addPermission android:name="android.permission.WAKE_LOCK" />
    <addPermission android:name="android.permission.INTERNET" />
    <addPermission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <addPermission android:name="android.permission.READ_PHONE_STATE" />

    <addElements tag="application">
      <service android:name="org.eclipse.paho.android.service.MqttService" />
    </addElements>
  </androidManifestUpdates>

  <buildGradleAdditions>
    <insert>
      dependencies {
        implementation 'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.1.0'
        implementation 'org.eclipse.paho:org.eclipse.paho.android.service:1.1.1'
      }
      repositories {
        maven {
          url "https://repo.eclipse.org/content/repositories/paho-snapshots/"
        }
      }
    </insert>
  </buildGradleAdditions>

</root>
